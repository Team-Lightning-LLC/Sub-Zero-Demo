<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sub-Zero</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --white: #FFFFFF;
      --cream: #FFFDF7;
      --beige-light: #F9F6EF;
      --beige: #EBE6DC;
      --charcoal: #343633;
      --charcoal-light: #4a4d48;
      --accent: #8B7355;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'IBM Plex Sans', -apple-system, sans-serif;
      background: var(--beige-light);
      color: var(--charcoal);
      height: 100vh;
      overflow: hidden;
    }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--beige); }
    ::-webkit-scrollbar-thumb { background: rgba(52, 54, 51, 0.25); border-radius: 3px; }
    
    .container { display: flex; height: 100vh; padding: 24px; gap: 24px; }
    
    /* Document Panel */
    .doc-panel {
      width: 50%;
      display: flex;
      flex-direction: column;
      background: var(--white);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(52, 54, 51, 0.08);
      overflow: hidden;
    }
    
    .doc-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--beige);
      background: var(--cream);
    }
    
    .doc-header h2 {
      font-size: 16px;
      font-weight: 600;
      color: var(--charcoal);
    }
    
    .doc-header-sub {
      font-size: 12px;
      color: var(--charcoal-light);
      margin-top: 4px;
      opacity: 0.7;
    }
    
    .doc-list {
      flex: 1;
      overflow: auto;
      padding: 16px;
    }
    
    /* Document Item */
    .doc-item {
      border: 1px solid var(--beige);
      border-radius: 10px;
      margin-bottom: 12px;
      overflow: hidden;
      transition: all 0.2s;
    }
    
    .doc-item:hover {
      border-color: var(--charcoal-light);
    }
    
    .doc-item.expanded {
      border-color: var(--charcoal);
    }
    
    .doc-item-header {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      background: var(--cream);
      transition: background 0.2s;
    }
    
    .doc-item-header:hover {
      background: var(--beige-light);
    }
    
    .doc-item.expanded .doc-item-header {
      background: var(--charcoal);
      color: var(--white);
    }
    
    .doc-item-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .doc-item-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: var(--beige-light);
      border: 1px solid var(--beige);
    }
    
    .doc-item.expanded .doc-item-icon {
      background: rgba(255,255,255,0.15);
      border-color: rgba(255,255,255,0.2);
    }
    
    .doc-item-title {
      font-size: 14px;
      font-weight: 500;
    }
    
    .doc-item-meta {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 2px;
    }
    
    .doc-item-toggle {
      font-size: 12px;
      opacity: 0.5;
      transition: transform 0.2s;
    }
    
    .doc-item.expanded .doc-item-toggle {
      transform: rotate(180deg);
    }
    
    .doc-item-content {
      display: none;
      padding: 20px;
      background: var(--white);
      max-height: 400px;
      overflow: auto;
      border-top: 1px solid var(--beige);
      line-height: 1.7;
    }
    
    .doc-item.expanded .doc-item-content {
      display: block;
    }
    
    /* Markdown styles in doc content */
    .doc-item-content h1 { font-size: 20px; color: var(--charcoal); margin-bottom: 10px; border-bottom: 2px solid var(--beige); padding-bottom: 10px; }
    .doc-item-content h2 { font-size: 16px; color: var(--charcoal); margin: 20px 0 10px; font-weight: 600; }
    .doc-item-content h3 { font-size: 13px; color: var(--charcoal-light); margin: 14px 0 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .doc-item-content p { margin-bottom: 12px; color: var(--charcoal); font-size: 13px; opacity: 0.85; }
    .doc-item-content ul, .doc-item-content ol { margin: 10px 0 10px 24px; font-size: 13px; opacity: 0.85; }
    .doc-item-content li { margin-bottom: 6px; }
    .doc-item-content table { width: 100%; border-collapse: collapse; margin: 14px 0; font-size: 12px; }
    .doc-item-content th { background: var(--beige-light); padding: 8px 10px; text-align: left; border: 1px solid var(--beige); font-weight: 600; }
    .doc-item-content td { padding: 8px 10px; border: 1px solid var(--beige); }
    .doc-item-content code { background: var(--beige-light); padding: 2px 5px; border-radius: 3px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; }
    .doc-item-content blockquote { border-left: 3px solid var(--accent); padding: 10px 14px; margin: 14px 0; background: var(--cream); border-radius: 0 6px 6px 0; font-size: 13px; }
    .doc-item-content strong { color: var(--charcoal); font-weight: 600; }
    
    .loading-state, .error-state {
      text-align: center;
      padding: 40px;
      color: var(--charcoal-light);
      opacity: 0.6;
    }
    
    .error-state { color: #b85c5c; }
    
    /* Chat Panel */
    .chat-panel { 
      width: 50%; 
      display: flex; 
      flex-direction: column; 
      background: var(--white);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(52, 54, 51, 0.08);
      overflow: hidden;
    }
    
    .chat-header { 
      padding: 20px 24px; 
      border-bottom: 1px solid var(--beige); 
      background: var(--cream); 
    }
    
    .chat-header h2 { 
      font-size: 16px; 
      font-weight: 600; 
      color: var(--charcoal); 
    }
    
    .chat-subtitle { 
      font-size: 12px; 
      color: var(--charcoal-light); 
      margin-top: 4px; 
      opacity: 0.7; 
    }
    
    .suggestions { 
      padding: 14px 24px; 
      border-bottom: 1px solid var(--beige); 
      background: var(--cream); 
    }
    
    .suggestions-label { 
      font-size: 11px; 
      color: var(--charcoal-light); 
      margin-bottom: 10px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
      opacity: 0.7; 
    }
    
    .suggestions-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
    }
    
    .suggestion-btn { 
      padding: 8px 14px; 
      background: var(--white); 
      border: 1px solid var(--beige); 
      border-radius: 8px; 
      color: var(--charcoal-light); 
      font-size: 12px; 
      cursor: pointer; 
      transition: all 0.2s; 
    }
    
    .suggestion-btn:hover { 
      border-color: var(--charcoal); 
      color: var(--charcoal); 
      background: var(--beige-light); 
    }
    
    .chat-messages { 
      flex: 1; 
      overflow: auto; 
      padding: 24px; 
      display: flex; 
      flex-direction: column; 
      gap: 16px; 
      background: var(--beige-light); 
    }
    
    .message { 
      max-width: 85%; 
      padding: 14px 18px; 
      border-radius: 14px; 
      font-size: 14px; 
      line-height: 1.6; 
      animation: fadeIn 0.3s ease; 
    }
    
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    
    .message.user { 
      align-self: flex-end; 
      background: var(--charcoal); 
      color: var(--white); 
      border-bottom-right-radius: 4px; 
    }
    
    .message.assistant { 
      align-self: flex-start; 
      background: var(--white); 
      border: 1px solid var(--beige); 
      border-bottom-left-radius: 4px; 
      color: var(--charcoal); 
      box-shadow: 0 2px 8px rgba(52, 54, 51, 0.04); 
    }
    
    .message.assistant p { margin-bottom: 10px; }
    .message.assistant p:last-child { margin-bottom: 0; }
    .message.assistant ul { margin: 8px 0 8px 20px; }
    .message.assistant strong { color: var(--charcoal); font-weight: 600; }
    .message.assistant code { background: var(--beige-light); padding: 2px 5px; border-radius: 3px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; }
    
    .typing { display: flex; gap: 5px; padding: 8px 0; }
    .typing span { width: 8px; height: 8px; background: var(--charcoal-light); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; opacity: 0.5; }
    .typing span:nth-child(1) { animation-delay: -0.32s; }
    .typing span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    
    .chat-input-area { 
      padding: 18px 24px; 
      border-top: 1px solid var(--beige); 
      background: var(--white); 
    }
    
    .chat-input-wrapper { 
      display: flex; 
      gap: 12px; 
    }
    
    .chat-input { 
      flex: 1; 
      padding: 14px 18px; 
      background: var(--beige-light); 
      border: 1px solid var(--beige); 
      border-radius: 12px; 
      color: var(--charcoal); 
      font-size: 14px; 
      font-family: inherit; 
      resize: none; 
      outline: none; 
      transition: border-color 0.2s; 
    }
    
    .chat-input:focus { border-color: var(--charcoal-light); }
    .chat-input::placeholder { color: var(--charcoal-light); opacity: 0.5; }
    
    .send-btn { 
      width: 52px; 
      height: 52px; 
      border-radius: 12px; 
      border: none; 
      background: var(--charcoal); 
      color: var(--white); 
      cursor: pointer; 
      font-size: 18px; 
      transition: all 0.2s; 
    }
    
    .send-btn:hover { background: var(--charcoal-light); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Left: Document List -->
    <div class="doc-panel">
      <div class="doc-header">
        <h2>Documentation</h2>
        <div class="doc-header-sub">Click to expand documents</div>
      </div>
      <div class="doc-list" id="docList">
        <div class="loading-state">Loading documents...</div>
      </div>
    </div>
    
    <!-- Right: Chat -->
    <div class="chat-panel">
      <div class="chat-header">
        <h2>Machinery Servicing Assistant</h2>
        <div class="chat-subtitle">Powered by Vertesia</div>
      </div>
      
      <div class="suggestions">
        <div class="suggestions-label">Try asking</div>
        <div class="suggestions-list">
          <button class="suggestion-btn" onclick="askQuestion('What causes voids?')">What causes voids?</button>
          <button class="suggestion-btn" onclick="askQuestion('What PPE do I need for seals?')">PPE for seals?</button>
          <button class="suggestion-btn" onclick="askQuestion('How often should I replace seals?')">Seal interval?</button>
          <button class="suggestion-btn" onclick="askQuestion('What is the part number for seals?')">Seal part #?</button>
        </div>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        <div class="message assistant">
          <p>Hello! I'm your Machinery Servicing Assistant. I can search across all loaded documentation to answer your questions about safety, maintenance, troubleshooting, and parts.</p>
        </div>
      </div>
      
      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea class="chat-input" id="chatInput" placeholder="Ask about servicing and maintenance..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">â–¶</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // VERTESIA CONFIGURATION
    // ============================================
    const CONFIG = {
      BASE_URL: 'https://api.vertesia.io/api/v1',
      API_KEY: 'sk-780d20f68cd5c5b0682baee88db0af70',
      ENVIRONMENT_ID: '681915c6a01fb262a410c161',
      MODEL: 'claude-sonnet-4',
      INTERACTION: 'Document Chat'
    };

    // ============================================
    // STATE
    // ============================================
    let documents = [];
    let conversationHistory = [];
    let isLoading = false;

    // ============================================
    // DOCUMENT LOADING
    // ============================================
    async function loadDocuments() {
      const docList = document.getElementById('docList');
      
      try {
        // Load all objects
        const response = await fetch(`${CONFIG.BASE_URL}/objects?limit=1000`, {
          headers: {
            'Authorization': `Bearer ${CONFIG.API_KEY}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error(`Failed to load: ${response.status}`);
        
        const data = await response.json();
        const objects = Array.isArray(data) ? data : data.objects || [];
        
        console.log(`[Docs] Found ${objects.length} objects`);

        // Load each document's content
        for (const obj of objects) {
          try {
            const fullObj = await getObject(obj.id);
            let content = '';

            if (fullObj.content?.source) {
              const source = fullObj.content.source;
              if (typeof source === 'string') {
                if (source.startsWith('gs://') || source.startsWith('s3://') || source.includes('/')) {
                  content = await downloadText(source);
                } else {
                  content = source;
                }
              } else if (typeof source === 'object') {
                const fileRef = source.file || source.store || source.path;
                if (fileRef) content = await downloadText(fileRef);
              }
            } else if (fullObj.text) {
              content = fullObj.text;
            }

            if (content && content.length > 50) {
              documents.push({
                id: obj.id,
                name: obj.name || 'Untitled',
                content: content,
                created: obj.created_at
              });
              console.log(`[Docs] Loaded: ${obj.name}`);
            }
          } catch (err) {
            console.warn(`[Docs] Failed to load ${obj.name}:`, err.message);
          }
        }

        if (documents.length === 0) {
          docList.innerHTML = '<div class="error-state">No documents found</div>';
          return;
        }

        renderDocumentList();

      } catch (error) {
        console.error('[Docs] Load failed:', error);
        docList.innerHTML = `<div class="error-state">Failed to load documents: ${error.message}</div>`;
      }
    }

    async function getObject(id) {
      const response = await fetch(`${CONFIG.BASE_URL}/objects/${encodeURIComponent(id)}`, {
        headers: {
          'Authorization': `Bearer ${CONFIG.API_KEY}`,
          'Content-Type': 'application/json'
        }
      });
      if (!response.ok) throw new Error('Failed to get object');
      return response.json();
    }

    async function downloadText(fileRef) {
      const urlResponse = await fetch(`${CONFIG.BASE_URL}/objects/download-url`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${CONFIG.API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ file: fileRef, format: 'original' })
      });
      
      if (!urlResponse.ok) throw new Error('Failed to get download URL');
      const urlData = await urlResponse.json();
      
      const contentResponse = await fetch(urlData.url);
      if (!contentResponse.ok) throw new Error('Download failed');
      return contentResponse.text();
    }

    // ============================================
    // DOCUMENT LIST RENDERING
    // ============================================
    function renderDocumentList() {
      const docList = document.getElementById('docList');
      
      docList.innerHTML = documents.map((doc, i) => `
        <div class="doc-item" id="doc-${i}">
          <div class="doc-item-header" onclick="toggleDocument(${i})">
            <div class="doc-item-info">
              <div class="doc-item-icon">ðŸ“„</div>
              <div>
                <div class="doc-item-title">${escapeHtml(doc.name)}</div>
                <div class="doc-item-meta">${formatBytes(doc.content.length)} â€¢ ${documents.length > 0 ? i + 1 + ' of ' + documents.length : ''}</div>
              </div>
            </div>
            <div class="doc-item-toggle">â–¼</div>
          </div>
          <div class="doc-item-content" id="doc-content-${i}"></div>
        </div>
      `).join('');
    }

    function toggleDocument(index) {
      const item = document.getElementById(`doc-${index}`);
      const content = document.getElementById(`doc-content-${index}`);
      
      // Close all others
      document.querySelectorAll('.doc-item').forEach((el, i) => {
        if (i !== index) {
          el.classList.remove('expanded');
        }
      });
      
      // Toggle this one
      const isExpanded = item.classList.toggle('expanded');
      
      // Render content if expanding
      if (isExpanded && content.innerHTML === '') {
        content.innerHTML = marked.parse(documents[index].content);
      }
    }

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================
    // CHAT FUNCTIONALITY
    // ============================================
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const question = input.value.trim();
      if (!question || isLoading) return;

      input.value = '';
      isLoading = true;
      document.getElementById('sendBtn').disabled = true;

      addMessage(question, 'user');
      const typingId = showTyping();

      try {
        // Step 1: Create run via /execute/async
        const response = await fetch(`${CONFIG.BASE_URL}/execute/async`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${CONFIG.API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            type: 'conversation',
            interaction: CONFIG.INTERACTION,
            data: {
              task: question,
              environment: CONFIG.ENVIRONMENT_ID,
              model: CONFIG.MODEL
            }
          })
        });

        if (!response.ok) {
          throw new Error(`Execute failed: ${response.status}`);
        }

        const data = await response.json();
        console.log('[Chat] Execute response:', data);

        const runId = data.runId || data.run_id || data.id;
        
        if (!runId) {
          throw new Error('No run ID returned');
        }

        // Step 2: Stream response
        const answer = await streamRun(runId, typingId);
        
        conversationHistory.push({ role: 'user', content: question });
        conversationHistory.push({ role: 'assistant', content: answer });

      } catch (error) {
        console.error('[Chat] Error:', error);
        removeTyping(typingId);
        addMessage(`Error: ${error.message}`, 'assistant');
      } finally {
        isLoading = false;
        document.getElementById('sendBtn').disabled = false;
      }
    }

    async function streamRun(runId, typingId) {
      const url = `${CONFIG.BASE_URL}/runs/${runId}/stream?access_token=${CONFIG.API_KEY}`;
      console.log('[Stream] URL:', url);
      
      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: { 'Accept': 'text/event-stream' }
        });

        if (!response.ok) {
          throw new Error(`Stream failed: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';
        let messageEl = null;
        let hasAnswer = false;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                console.log('[Stream] Data:', data);
                
                // Check for answer type
                if (data.type === 'answer' && data.message && !hasAnswer) {
                  hasAnswer = true;
                  fullText = data.message;
                  removeTyping(typingId);
                  addMessage(fullText, 'assistant');
                  return fullText;
                }
                
                // Streaming text
                const text = data.content || data.text || data.delta || data.message || '';
                if (text && !hasAnswer) {
                  fullText += text;
                  if (!messageEl) {
                    removeTyping(typingId);
                    messageEl = addMessage(fullText, 'assistant', true);
                  } else {
                    updateMessage(messageEl, fullText);
                  }
                }
                
                // Completion
                if (data.type === 'complete' || data.type === 'done') {
                  if (fullText && !hasAnswer) return fullText;
                }
              } catch (e) {}
            }
          }
        }

        if (fullText && !hasAnswer) return fullText;
        
        removeTyping(typingId);
        addMessage('Response completed.', 'assistant');
        return '';

      } catch (error) {
        console.error('[Stream] Error:', error);
        removeTyping(typingId);
        addMessage(`Stream error: ${error.message}`, 'assistant');
        return '';
      }
    }

    function addMessage(text, role, streaming = false) {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.innerHTML = role === 'assistant' ? marked.parse(text) : escapeHtml(text);
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div;
    }

    function updateMessage(el, text) {
      el.innerHTML = marked.parse(text);
      document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    }

    function showTyping() {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'message assistant';
      div.id = 'typing-' + Date.now();
      div.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div.id;
    }

    function removeTyping(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function askQuestion(question) {
      document.getElementById('chatInput').value = question;
      sendMessage();
    }

    function handleKeyDown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    // ============================================
    // INIT
    // ============================================
    loadDocuments();
  </script>
</body>
</html>
